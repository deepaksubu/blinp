This version seems to work. Timers have been added to avoid EBUSY errors when writing and reading the flash.
